@page "/adminDeliveryCompanies"
@using ETicaret_UI.ViewModals
@rendermode InteractiveServer
@attribute [StreamRendering]

<PageTitle>Admin Delivery Company Panel</PageTitle>

<AuthorizeView Roles="admin">
    <Authorized>
        <div class="container mt-4">

            <BlazoredToasts Position="ToastPosition.BottomRight"
                            Timeout="10"
                            ShowCloseButton="@true"
                            MaxToastCount="3"
                            IconType="IconType.FontAwesome"
                            SuccessClass="success-toast-override"
                            SuccessIcon="fa fa-thumbs-up"
                            ErrorIcon="fa fa-bug" />

            <h2 class="mb-4">Kargo Şirketleri</h2>

            <button class="btn btn-success mb-3" @onclick="ShowAddModal">Yeni Kargo Şirketi Ekle</button>

            <table class="table table-striped table-hover shadow-sm rounded">
                <thead class="table-dark">
                    <tr>
                        <th>Şirket Adı</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in companies)
                    {
                        <tr>
                            <td>@item.Name</td>
                            <td>
                                <button class="btn btn-primary btn-sm me-2" @onclick="() => EditCompany(item)">Düzenle</button>
                                <button class="btn btn-danger btn-sm" @onclick="() => ShowDeleteModal(item)">Sil</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Add / Edit Modal -->
        @if (showEditModal && selectedCompany != null)
        {
            <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog">
                    <div class="modal-content shadow-lg">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">@((isAddMode ? "Yeni Kargo Şirketi Ekle" : "Kargo Şirketini Düzenle"))</h5>
                            <button type="button" class="btn-close" @onclick="CloseEditModal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Şirket Adı</label>
                                <input class="form-control" @bind="selectedCompany.Name" />
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" @onclick="CloseEditModal">İptal</button>
                            <button class="btn btn-primary" @onclick="SaveEditCompany">Kaydet</button>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Delete Modal -->
        @if (showDeleteModal)
        {
            <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog">
                    <div class="modal-content shadow-lg">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">Silme Onayı</h5>
                            <button type="button" class="btn-close" @onclick="CloseDeleteModal"></button>
                        </div>
                        <div class="modal-body">
                            <p>Seçili kargo şirketini silmek istediğinizden emin misiniz?</p>
                            <strong>@selectedCompany?.Name</strong>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" @onclick="CloseDeleteModal">İptal</button>
                            <button class="btn btn-danger" @onclick="DeleteCompany">Sil</button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </Authorized>
    <NotAuthorized>
        <ETicaret_UI.Components.Pages.AuthPages.AccessDenied />
    </NotAuthorized>
</AuthorizeView>

@code {
    List<DeliveryCompanyViewModel> companies = new();
    private bool showDeleteModal = false;
    private bool showEditModal = false;
    private bool isAddMode = false;
    private DeliveryCompanyViewModel? selectedCompany;

    async Task ReadData()
    {
        companies.Clear();
        var response = await RequestManager.GetAsync<List<JsonElement>>(ApiSettings.GetCompanies);
        foreach (var item in response)
        {
            companies.Add(new DeliveryCompanyViewModel
            {
                Id = item.GetProperty("id").GetInt32(),
                Name = item.GetProperty("name").GetString()
            });
        }
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ReadData();
        }
    }

    private void ShowAddModal()
    {
        selectedCompany = new DeliveryCompanyViewModel();
        isAddMode = true;
        showEditModal = true;
    }

    private void EditCompany(DeliveryCompanyViewModel company)
    {
        selectedCompany = new DeliveryCompanyViewModel
        {
            Id = company.Id,
            Name = company.Name
        };
        isAddMode = false;
        showEditModal = true;
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        selectedCompany = null;
    }

    private async Task SaveEditCompany()
    {
        try
        {
            if (selectedCompany == null) return;

            var payload = selectedCompany.Name; // sadece string gönderiliyor!

            if (isAddMode)
            {
                await RequestManager.PostAsync<string, string>(ApiSettings.AddCompany, payload);
            }
            else
            {
                ApiSettings.companyId = selectedCompany.Id;
                await RequestManager.PutAsync<string, object>(ApiSettings.UpdateCompany, payload);
                ApiSettings.companyId = 0;
            }
            ToastService.ShowSuccess("İşlem Başarılı");
            showEditModal = false;
            await ReadData();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    private void ShowDeleteModal(DeliveryCompanyViewModel company)
    {
        selectedCompany = company;
        showDeleteModal = true;
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        selectedCompany = null;
    }

    private async Task DeleteCompany()
    {
        try
        {
            if (selectedCompany == null) return;

            ApiSettings.companyId = selectedCompany.Id;
            await RequestManager.DeleteAsync(ApiSettings.DeleteCompany);
            ApiSettings.companyId = 0;
            ToastService.ShowSuccess("Silme Başarılı");
            showDeleteModal = false;
            await ReadData();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }
}

